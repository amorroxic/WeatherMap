// Generated by CoffeeScript 1.3.3
(function(){var e,t,n,r,i,s,o,u,a,f=function(e,t){return function(){return e.apply(t,arguments)}},l={}.hasOwnProperty,c=function(e,t){function r(){this.constructor=e}for(var n in t)l.call(t,n)&&(e[n]=t[n]);r.prototype=t.prototype;e.prototype=new r;e.__super__=t.prototype;return e},h=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1};a=function(){function t(){this.handleAutocompleteLocationNotFound=f(this.handleAutocompleteLocationNotFound,this);this.handleAutocompleteAddCity=f(this.handleAutocompleteAddCity,this);this.handleLocationRemovedFromMap=f(this.handleLocationRemovedFromMap,this);this.handleCitiesIsUnknown=f(this.handleCitiesIsUnknown,this);this.handleCityRefreshError=f(this.handleCityRefreshError,this);this.handleCityWasRefreshed=f(this.handleCityWasRefreshed,this);this.handleAllCitiesLoaded=f(this.handleAllCitiesLoaded,this);this.handleNewCityLoaded=f(this.handleNewCityLoaded,this);this.initialize();this.run()}t.eventTestInstance=null;t.localStorageInstance=null;t.mapInstance=null;t.cities=null;t.prototype.initialize=function(){var t,i=this;this.cities=new r;this.cities.addListener(r.CITIES_NEW,this.handleNewCityLoaded);this.cities.addListener(r.CITIES_COMPLETE,this.handleAllCitiesLoaded);this.cities.addListener(r.CITIES_UPDATE,this.handleCityWasRefreshed);this.cities.addListener(r.CITIES_FAILURE,this.handleCityRefreshError);this.cities.addListener(r.CITIES_UNKNOWN,this.handleCitiesIsUnknown);this.mapInstance=new u("container");this.mapInstance.addListener(u.LOCATION_IS_REMOVED,this.handleLocationRemovedFromMap);this.autocompleteInstance=new n("searchbox");this.autocompleteInstance.addListener(n.AUTOCOMPLETE_QUERY,this.handleAutocompleteAddCity);this.autocompleteInstance.addListener(n.AUTOCOMPLETE_NOTFOUND,this.handleAutocompleteLocationNotFound);t=this.mapInstance.getGoogleMapsInstance();this.autocompleteInstance.bindToGoogleMap(t);return e(".blue-pill").bind("click",function(e){return i.cities.coldRefreshForecasts()})};t.prototype.run=function(){return this.cities.populate()};t.prototype.handleNewCityLoaded=function(e){return this.mapInstance.addCityToMap(e)};t.prototype.handleAllCitiesLoaded=function(){return this.cities.mildRefreshForecasts()};t.prototype.handleCityWasRefreshed=function(e){return this.mapInstance.updateCity(e)};t.prototype.handleCityRefreshError=function(e){return console.log("Failed updating forecast for "+e.name)};t.prototype.handleCitiesIsUnknown=function(e){return console.log("Could not geolocate "+e.name)};t.prototype.handleLocationRemovedFromMap=function(e){return this.cities.removeCity(e)};t.prototype.handleAutocompleteAddCity=function(e){return this.cities.generateIdAndAddCity(e)};t.prototype.handleAutocompleteLocationNotFound=function(){return console.log("Location not found")};return t}();Date.prototype.yyyymmdd=function(){var e,t;t=[this.getFullYear(),this.getMonth()+1,this.getDate()].join("-");e=/\b(\d)\b/g;t=t.replace(e,"0$1");t.replace(/\s/g,"");return t};document.addEventListener("DOMContentLoaded",function(){return window.weatherMapPresenter=new a},!1);(function(e){var t,n,r,i;t=function(){};n=function(e,t){var n;if(r)return t.indexOf(e);n=t.length;if(function(){var r;r=[];while(n--)r.push(t[n]===e);return r}())return n};i=t.prototype;r=Array.prototype.indexOf?!0:!1;i.getListeners=function(e){var t;t=this._events||(this._events={});return t[e]||(t[e]=[])};i.addListener=function(e,t){var r;r=this.getListeners(e);n(t,r)===-1&&r.push(t);return this};i.removeListener=function(e,t){var r,i;i=this.getListeners(e);r=n(t,i);if(r!==-1){i.splice(r,1);i.length===0&&(this._events[e]=null)}return this};i.addListeners=function(e,t){return this.manipulateListeners(!1,e,t)};i.removeListeners=function(e,t){return this.manipulateListeners(!0,e,t)};i.manipulateListeners=function(e,t,n){var r,i,s,o;r=void 0;o=void 0;s=e?this.removeListener:this.addListener;i=e?this.removeListeners:this.addListeners;if(typeof t=="object")for(r in t)t.hasOwnProperty(r)&&(o=t[r])&&(typeof o=="function"?s.call(this,r,o):i.call(this,r,o));else{r=n.length;while(r--)s.call(this,t,n[r])}return this};i.removeEvent=function(e){e?this._events[e]=null:this._events=null;return this};i.emitEvent=function(e,t){var n,r,i;r=this.getListeners(e);n=r.length;i=void 0;while(n--){i=t?r[n].apply(null,t):r[n]();i===!0&&this.removeListener(e,r[n])}return this};return e.EventEmitter=t})(this);o=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}c(t,e);t.prototype.store=function(e,t){return localStorage.setItem(e,JSON.stringify(t))};t.prototype.retrieve=function(e){var t,n;n=localStorage.getItem(e);t=JSON.parse(n);return t};t.prototype.remove=function(e){return localStorage.removeItem(e)};return t}(EventEmitter);t=function(e){function n(e){t=e}var t;c(n,e);n.LOAD_FAILED="ajax_load_failed";n.LOAD_SUCCESS="ajax_load_success";t=null;n.prototype.perform=function(e){var r=this;return jQuery.ajax({url:t,type:"GET",dataType:"jsonp",data:e,error:function(e,t,i){return r.emitEvent(n.LOAD_FAILED,[t])},success:function(e,t,i){return r.emitEvent(n.LOAD_SUCCESS,[e])}})};return n}(EventEmitter);e=jQuery;n=function(t){function n(t){this.handleAutocomplete=f(this.handleAutocomplete,this);var n;this.selectorID=t;this.element=e("#"+t)[0];n={types:["(cities)"]};this.autocompleteInstance=new google.maps.places.Autocomplete(this.element,n)}c(n,t);n.AUTOCOMPLETE_QUERY="autocomplete_query_string";n.AUTOCOMPLETE_NOTFOUND="autocomplete_query_not_found";n.autocompleteInstance=null;n.element=null;n.selectorID=null;n.prototype.bindToGoogleMap=function(e){this.autocompleteInstance.bindTo("bounds",e);return google.maps.event.addListener(this.autocompleteInstance,"place_changed",this.handleAutocomplete)};n.prototype.handleAutocomplete=function(){var e,t,r,i,s,o,u,a;s=this.autocompleteInstance.getPlace();if(!s.geometry){this.emitEvent(n.AUTOCOMPLETE_NOTFOUND,[]);return}a=s.address_components;for(o=0,u=a.length;o<u;o++){e=a[o];h.call(e.types,"locality")>=0&&!r&&(r=e.long_name);h.call(e.types,"country")>=0&&!t&&(t=e.long_name)}i={name:r+", "+t,coordinates:{latitude:s.geometry.location.lat(),longitude:s.geometry.location.lng()}};this.emitEvent(n.AUTOCOMPLETE_QUERY,[i]);return!1};return n}(EventEmitter);s=function(e){function r(e){n=e;t=new google.maps.Geocoder}var t,n;c(r,e);r.SUCCESS="geocoder_success";r.FAILURE="geocoder_failure";n=null;t=null;r.prototype.perform=function(){var e,i,s=this;console.log("Geocoder performing: "+n);e={address:n};return i=t.geocode(e,function(e,t){var n,i,o,u,a,f,l,c,p,d;if(t===google.maps.GeocoderStatus.OK){o="";i="";for(f=0,c=e.length;f<c;f++){a=e[f];d=a.address_components;for(l=0,p=d.length;l<p;l++){n=d[l];h.call(n.types,"locality")>=0&&!o&&(o=n.long_name);h.call(n.types,"country")>=0&&!i&&(i=n.long_name)}}u={location:o+", "+i,coordinates:{latitude:e[0].geometry.location.lat(),longitude:e[0].geometry.location.lng()}};return s.emitEvent(r.SUCCESS,[u])}return s.emitEvent(r.FAILURE)})};return r}(EventEmitter);i=function(e){function n(e){this.forecastFailure=f(this.forecastFailure,this);this.forecastSuccess=f(this.forecastSuccess,this);this.geolocationFailure=f(this.geolocationFailure,this);this.geolocationSuccess=f(this.geolocationSuccess,this);this.id=e.id;this.location=e.name;this.forecast={};e.coords!=null?this.coordinates=e.coords:this.coordinates={};this.hasForecast=!1;this.isGeolocated=!1;this.lockQueryForecast=!1;this.weatherAPI="http://free.worldweatheronline.com/feed/weather.ashx"}c(n,e);n.id=null;n.location=null;n.coordinates=null;n.forecast=null;n.isGeolocated=null;n.hasForecast=null;n.weatherAPI=null;n.lockQueryForecast=null;n.CITY_LOADED="city_cache_loaded";n.CITY_UNKNOWN="city_is_unknown";n.CITY_FORECAST_FAILED="city_forecast_failed";n.CITY_FORECAST_SUCCESS="city_forecast_success";n.prototype.initialize=function(){var e;e=this.populateData();if(e)return this.emitEvent(n.CITY_LOADED,[this])};n.prototype.populateData=function(){var e,t;e=!1;if(this.id!=null)if(this.coordinates!=null){this.isGeolocated=this.hasValidCoordinates();if(!this.isGeolocated)this.geolocateMe();else{e=!0;if(this.forecast!=null&&this.forecast.current!=null){t=this.hasValidForecast();t&&(this.hasForecast=!0)}}}else this.geolocateMe();return e};n.prototype.hasValidCoordinates=function(){var e;e=!1;this.coordinates!=null&&this.coordinates.latitude!=null&&this.coordinates.longitude!=null&&(e=!0);return e};n.prototype.geolocateMe=function(){var e;this.forecast={};this.hasForecast=!1;e=new s(this.location);e.addListener(s.SUCCESS,this.geolocationSuccess);e.addListener(s.FAILURE,this.geolocationFailure);return e.perform()};n.prototype.geolocationSuccess=function(e){this.location=e.location;this.coordinates=e.coordinates;this.isGeolocated=this.hasValidCoordinates();return this.emitEvent(n.CITY_LOADED,[this])};n.prototype.geolocationFailure=function(e){return this.emitEvent(n.CITY_UNKNOWN,[this])};n.prototype.refreshForecast=function(){var e,n;if(!this.lockQueryForecast){console.log("Refreshing forecast for: "+this.location);this.lockQueryForecast=!0;n=new t(this.weatherAPI);n.addListener(t.LOAD_SUCCESS,this.forecastSuccess);n.addListener(t.LOAD_FAILED,this.forecastFailure);e={q:this.location,format:"json",num_of_days:2,key:"bbfbbfb160072942122708"};return n.perform(e)}};n.prototype.forecastSuccess=function(e){this.lockQueryForecast=!1;if(e.data.error==null){this.populateForecast(e.data);this.hasForecast=!0;return this.emitEvent(n.CITY_FORECAST_SUCCESS,[this])}return this.emitEvent(n.CITY_FORECAST_FAILED,[this])};n.prototype.forecastFailure=function(e){this.lockQueryForecast=!1;return this.emitEvent(n.CITY_FORECAST_FAILED,[this])};n.prototype.populateForecast=function(e){var t,n,r,i,s,o,u;t={date:e.weather[0].date,time:e.current_condition[0].observation_time,precip_mm:e.current_condition[0].precipMM,temp:{f:e.current_condition[0].temp_F,c:e.current_condition[0].temp_C},visibility:e.current_condition[0].visibility,description:e.current_condition[0].weatherDesc[0].value,icon:e.current_condition[0].weatherIconUrl[0].value,wind:{m:e.current_condition[0].windspeedMiles,km:e.current_condition[0].windspeedKmph,direction:e.current_condition[0].winddir16Point},clouds:e.current_condition[0].cloudcover,humidity:e.current_condition[0].humidity,pressure:e.current_condition[0].pressure};this.forecast.current=t;this.forecast.days={};o=e.weather;u=[];for(i=0,s=o.length;i<s;i++){n=o[i];r={date:n.date,precip_mm:n.precipMM,temp_min:{f:n.tempMinF,c:n.tempMinC},temp_max:{f:n.tempMaxF,c:n.tempMaxC},description:n.weatherDesc[0].value,icon:n.weatherIconUrl[0].value,wind:{m:n.windspeedMiles,km:n.windspeedKmph,direction:n.winddir16Point}};this.forecast.days[n.date]=r;u.push(r=null)}return u};n.prototype.hasValidForecast=function(){var e,t;t=!1;e=new Date;e=e.yyyymmdd();this.forecast&&this.forecast.current&&this.forecast.current.date===e&&(t=!0);return t};n.prototype.getForecastOverview=function(){var e,t;e=this.location;t=this.hasValidForecast();t&&(e=this.location+" at "+this.forecast.current.time+": "+this.forecast.current.temp.c+"&deg;C, "+this.forecast.current.description);return e};n.prototype.getData=function(){var e;e={id:this.id,name:this.location,coords:this.coordinates,forecast:this.forecast,overview:this.getForecastOverview()};return e};return n}(EventEmitter);r=function(e){function s(){this.handleCityForecastFail=f(this.handleCityForecastFail,this);this.handleCityForecastSuccess=f(this.handleCityForecastSuccess,this);this.handleCityUnknown=f(this.handleCityUnknown,this);this.handleCityLoaded=f(this.handleCityLoaded,this);t="geoweather";this.cities=[];r=0}var t,n,r;c(s,e);t=null;s.cities=null;n=["Dublin","London","Paris","Barcelona"];r=null;s.CITIES_NEW="city_new_added";s.CITIES_COMPLETE="cities_are_loaded";s.CITIES_UPDATE="city_forecast_update";s.CITIES_FAILURE="city_forecast_error";s.CITIES_UNKNOWN="city_unknown";s.prototype.cacheSave=function(){var e,n,r,i,s,o,u;r=[];u=this.cities;for(s=0,o=u.length;s<o;s++){n=u[s];i=n.getData();delete i.forecast;i.forecast={};r.push(i)}e={cities:r};return this.store(t,e)};s.prototype.populate=function(){var e,r,i,s,o,u,a,f,l,c,h;o=[];r=this.retrieve(t);if(r!=null&&r.cities!=null)o=r.cities;else{i=0;for(a=0,l=n.length;a<l;a++){e=n[a];i++;o.push({id:i,name:e,coords:{}})}}h=[];for(f=0,c=o.length;f<c;f++){s=o[f];u={id:s.id,name:s.name,coords:s.coords};h.push(this.addCityToStructure(u))}return h};s.prototype.addCityToStructure=function(e){var t;t=new i(e);t.addListener(i.CITY_LOADED,this.handleCityLoaded);t.addListener(i.CITY_UNKNOWN,this.handleCityUnknown);t.addListener(i.CITY_FORECAST_SUCCESS,this.handleCityForecastSuccess);t.addListener(i.CITY_FORECAST_FAILED,this.handleCityForecastFail);return t.initialize()};s.prototype.generateIdAndAddCity=function(e){var t,n;if(!this.cityExists(e.name)){t=this.getNewCityId();n={id:t,name:e.name,coords:e.coordinates};return this.addCityToStructure(n)}};s.prototype.cityExists=function(e){var t,n,r,i;i=this.cities;for(n=0,r=i.length;n<r;n++){t=i[n];if(e===t.name)return!0}return!1};s.prototype.getNewCityId=function(){var e,t,n,r,i;t=1;i=this.cities;for(n=0,r=i.length;n<r;n++){e=i[n];e.id>t&&(t=e.id)}t++;return t};s.prototype.findCityIndexForId=function(e){var t,n,r,i,s;n=0;s=this.cities;for(r=0,i=s.length;r<i;r++){t=s[r];if(t.id===e)return n;n++}return-1};s.prototype.removeCity=function(e){var t;t=parseInt(e,10);this.cities=this.cities.filter(function(e){return e.id!==t});this.cacheSave();return r--};s.prototype.handleCityLoaded=function(e){var t;this.cities.push(e);r++;t=e.getData();this.cacheSave();this.emitEvent(s.CITIES_NEW,[t]);if(r>=this.cities.length)return this.emitEvent(s.CITIES_COMPLETE,[])};s.prototype.handleCityUnknown=function(e){var t;t={id:e.id,name:e.location};return this.emitEvent(s.CITIES_UNKNOWN,[t])};s.prototype.handleCityForecastSuccess=function(e){var t,n,r;n=e.getData();t=this.findCityIndexForId(e.id);if(t>=0){this.cities[t]=e;this.cacheSave();r=e.hasValidForecast();return r?this.emitEvent(s.CITIES_UPDATE,[n]):this.emitEvent(s.CITIES_FAILURE,[n])}};s.prototype.handleCityForecastFail=function(e){var t,n;n=e.getData();t=this.findCityIndexForId(e.id);if(t>=0)return this.emitEvent(s.CITIES_FAILURE,[n])};s.prototype.coldRefreshForecasts=function(){var e,t,n,r,i;r=this.cities;i=[];for(t=0,n=r.length;t<n;t++){e=r[t];i.push(e.refreshForecast())}return i};s.prototype.mildRefreshForecasts=function(){var e,t,n,r,i,s;i=this.cities;s=[];for(n=0,r=i.length;n<r;n++){e=i[n];t=e.hasValidForecast();t?s.push(void 0):s.push(e.refreshForecast())}return s};s.prototype.showData=function(){return console.log(this)};return s}(o);e=jQuery;u=function(t){function n(t){var n,r;this.markers=[];this.parentSelectorID=t;this.parentElement=e("#"+t)[0];window.mapsWrapper=this;n=new google.maps.LatLng(53.3494426,-6.260082499999953);r={zoom:4,center:n,maxZoom:5,mapTypeId:google.maps.MapTypeId.TERRAIN};this.mapInstance=new google.maps.Map(this.parentElement,r)}c(n,t);n.parentSelectorID=null;n.parentElement=null;n.mapInstance=null;n.markers=null;n.LOCATION_IS_REMOVED="maps_location_removed_is_me";n.prototype.getGoogleMapsInstance=function(){return this.mapInstance};n.prototype.addCityToMap=function(e){var t,n,r,i;n=this.addForecastIcon(e);i={id:e.id,content:n,disableAutoPan:!0,zIndex:null,pixelOffset:new google.maps.Size(6,-17),boxClass:"tooltip",closeBoxURL:"img/close.png",closeBoxMargin:"-25px -22px 0 0",position:new google.maps.LatLng(e.coords.latitude,e.coords.longitude),isHidden:!1,pane:"floatPane",enableEventPropagation:!1,map:this.mapInstance};t=new InfoBox(i);r=new google.maps.Marker({map:this.mapInstance,position:new google.maps.LatLng(e.coords.latitude,e.coords.longitude),visible:!1});this.markers.push({id:e.id,city:e.name,box:t,symbol:r});return this.placeMarkersOnMap()};n.prototype.addForecastIcon=function(t){var n,r,i,s,o,u,a,f;r=t.overview;n=e("<div></div>").attr("rel",t.id).html(r);if(t.forecast!=null&&t.forecast.current!=null){u=e("<img></img>").attr("src",t.forecast.current.icon).width(26);a=e("<div></div>").addClass("forecast-icon");u.appendTo(a);a.appendTo(n)}if(t.forecast!=null&&t.forecast.days!=null){o=e("<div></div>").addClass("forecast-prognose").addClass("hide").attr("id","prognose-"+t.id);for(s in t.forecast.days){s===t.forecast.current.date?f="Today: ":f="Tomorrow: ";i=t.forecast.days[s];r=f+"Min "+i.temp_min.c+"&deg;C - Max "+i.temp_max.c+"&deg;C, "+i.description;a=e("<div></div>").addClass("forecast").html(r);a.appendTo(o)}o.appendTo(n)}n.bind("mouseover",function(t){var n,r;e(".tooltip").each(function(){return e(this).css("background-color","#40506c")});r=e(this).parent();r.css("background-color","#000");n=e(t.currentTarget).attr("rel");e(".forecast-prognose").each(function(){return e(this).removeClass("show").addClass("hide")});return e("#prognose-"+n).removeClass("hide").addClass("show")});return n[0]};n.prototype.updateCity=function(e){var t,n,r,i,s,o;if(this.markers.length){s=this.markers;o=[];for(r=0,i=s.length;r<i;r++){n=s[r];if(n.id===e.id){t=this.addForecastIcon(e);o.push(n.box.setContent(t))}else o.push(void 0)}return o}};n.prototype.clearOverlays=function(){var t,n,r,i,s;e(".tooltip").each(function(){return e(this).css("background-color","#40506c")});e(".forecast-prognose").each(function(){return e(this).removeClass("show").addClass("hide")});if(this.markers.length){i=this.markers;s=[];for(n=0,r=i.length;n<r;n++){t=i[n];google.maps.event.clearListeners(t.box,"closeclick");t.box.close;s.push(t.symbol.close)}return s}};n.prototype.placeMarkersOnMap=function(){var e,t,n,r,i,s;this.clearOverlays();if(this.markers.length){e=new google.maps.LatLngBounds;s=this.markers;for(r=0,i=s.length;r<i;r++){t=s[r];n=t.box.getPosition();e.extend(n);google.maps.event.addListener(t.box,"closeclick",this.locationRemoved);t.box.open(this.mapInstance,t.symbol)}return this.mapInstance.fitBounds(e)}};n.prototype.locationRemoved=function(){var t,n;n=this.getContent();t=e(n).attr("rel");return window.mapsWrapper.removeMarker(t)};n.prototype.removeMarker=function(e){var t,r,i,s;s=this.markers;for(r=0,i=s.length;r<i;r++){t=s[r];t.id===+e&&google.maps.event.clearListeners(t.box,"closeclick")}this.markers=this.markers.filter(function(t){return t.id!==+e});this.emitEvent(n.LOCATION_IS_REMOVED,[e]);return this.placeMarkersOnMap()};return n}(EventEmitter)}).call(this);